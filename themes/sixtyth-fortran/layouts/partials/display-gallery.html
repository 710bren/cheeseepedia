{{- $currentPageTitle := .Title -}} <!-- Get the base page title -->
{{- $photos := partialCached "grab-all-photos.html" "key"}}
{{- $hasGallery := 0 -}}
{{- $galleryOpen := false -}} <!-- Track whether the gallery div is open -->
{{- range sort $photos "Params.date" -}}
  {{- $matches := false -}} <!-- Flag to track if title matches in photos.pages array -->
  
  {{- range .Params.pages -}} <!-- Iterate through the pages array in photos parameter -->
    {{- if eq . $currentPageTitle -}} <!-- Check if the current page title matches -->
      {{- $matches = true -}}
      {{- if eq $hasGallery 0 -}} <!-- Open the gallery if this is the first match -->
        <h2>Gallery</h2>
        <div class="gallery">
        {{- $galleryOpen = true -}} <!-- Track that the gallery div is now open -->
      {{- end -}}
      {{- $hasGallery = add $hasGallery 1 -}} <!-- Increment gallery count -->
    {{- end -}}
  {{- end -}}

  {{- if $matches -}} <!-- If a match is found, display the photo -->
    <div class="gallery-image-box">
        {{- partial "filename-to-photo.html" .Title -}}
    </div>
  {{- end -}}
{{- end -}}

{{- if $galleryOpen -}} <!-- If the gallery div was opened, close it -->
</div>
{{- end -}}
